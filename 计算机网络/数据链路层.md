## 1.互联网中数据流向
![数据流向示意图](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg-blog.csdnimg.cn%2F20210303150453310.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3Nvbmd3dDkzMA%3D%3D%2Csize_16%2Ccolor_FFFFFF%2Ct_70%23pic_cente&refer=http%3A%2F%2Fimg-blog.csdnimg.cn&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1645864189&t=3489f6c749213a7d4e7aa60cf7327221 "数据流向示意图")

数据链路层使用的信道基本可以分为两大类：点到点，广播，在这两种信道下分别存在PPP协议以及CSMA/CD协议。
无论是PPP点到点协议还是CSMA/CD广播协议，在数据链路层的传输信道中都需要注意三个基本问题：封装成帧、透明传输、差错检测。
以下针对这几个问题进行详细解析

## 2.基本数据单元：帧
数据链路层把网络层下发的数据报封装成帧发送到链路上，以及把接收到的帧上交网络层拆分为数据报（网络层协议数据单元称为IP数据报、数据报、分组、包等）

![帧单元形成](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg.it610.com%2Fimage%2Finfo5%2F1c53de8ca11d49a6b7680bfd3de929c9.png&refer=http%3A%2F%2Fimg.it610.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1645867433&t=368b9f3d7c6f31dd60efead0b6511da2 "帧单元形成")

数据链路层的通信主要分为三个步骤：
1. 发送结点把下发的网络层数据报添加首部尾部形成帧
2. 发送结点把封装好的帧发送给接收结点
3. 接收结点确认收到的帧无差错，则从帧中提取数据报上交网络层，否则丢弃该帧

## 3.三个基本问题
### 1. 封装成帧

![封装成帧](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg-blog.csdnimg.cn%2Fimg_convert%2F451b298bbe755a2a4f1d789f1ace46fe.png&refer=http%3A%2F%2Fimg-blog.csdnimg.cn&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1645866731&t=766413de49565863a2d9c151c4c6ce9b "封装成帧")

发送时：网络层的IP数据报下发到数据链路层则会充当帧的数据部分，在帧的数据部分首部和尾部添加帧首部与帧尾部形成一个完整的帧。
接收时：物理接口获取物理层发送过来的比特流，根据比特流中的帧定界符截取一个完整的帧并上交给数据链路层。
（MTU为帧数据部分的长度上限）

### 2. 透明传输

![透明传输](https://img1.baidu.com/it/u=3956770589,2320758293&fm=253&fmt=auto&app=138&f=JPEG?w=1293&h=500 "透明传输")

帧固定使用某些字符作为帧定界符定义帧头帧尾，但如果帧的数据部分出现帧定界符，则会发生帧截取错误。
因此，使用字符填充（字节填充）的方式完善帧定界符的使用，即使用转义字符对数据部分出现的帧定界符进行转义，在解释数据部分时则不会被当作帧定界符

### 3. 差错检测
现实传输中可能会出现比特差错（‘1’变为‘0’），为了保证通信质量，可以使用循环冗余校验CRC，大致是定义一个若干位二进制除数B，将待传输比特流二进制数A除以该除数得到余数C。在发送A时，将C拼接在A尾部形成二进制数D进行发送，接收方将D除以B，若得到余数为0，则无差错；否则出现误码。
以上过程中，B称为FCS帧校验序列。

数据链路层使用循环冗余校验CRC进行差错检测，但校验粒度只是局限在帧中，即确保帧中的比特流在发送以及接收都是一致的。还存在另一种传输差错粒度在帧之间：帧丢失、帧失序、帧重复。

过去由于通信线路的质量有限，还在CRC校验的基础上增加帧编号、确认、重传机制（收到正确的帧就要向发送端发送确认，发送端在一定的期限内若没有收到对方的确认就认为出现差错而重传，直到收到对方的确认）。
现今对于通信质量良好的有线传输链路，数据链路层协议不使用确认和重传机制（在数据链路层不提供可靠传输服务），纠错依赖上层协议。对于通信质量较差的无线传输链路，数据链路层使用确认和重传机制。

## 4. 点对点信道协议PPP
协议由三部分组成：
1. 一个将IP数据报封装到串行链路的方法。PPP既支持一部分链路也支持面向比特的同步链路。IP数据报在PPP帧中就是其信息部分。这个信息部分长度受最大传送单元MTU限制。
2. 一个用来建立、配置和测试数据链路连接的链路控制协议LCP。通信双方可协商一些选项。
3. 一套网络控制协议NCP，其中每一个协议支持不同网络层协议。

![PPP帧格式](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg-blog.csdnimg.cn%2F20210121100226599.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDQ2NTM5Ng%3D%3D%2Csize_16%2Ccolor_FFFFFF%2Ct_70&refer=http%3A%2F%2Fimg-blog.csdnimg.cn&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1646115928&t=a8b25ad24461f5166d5be917699d78fb "PPP帧格式")

**帧格式**：
1. F字段为帧定界符
2. A、C字段无特殊含义
3. 协议字段为0x0021则PPP帧信息部分为IP数据报，为0xC021则PPP帧信息部分为LCP数据，为0x8021则PPP帧信息部分为NCP数据

**字节填充**：
当PPP使用异步传输时，它把转义符定义为0x7D，并使用字节填充：
1. 把信息字段中出现的每一个0x7E字节转变为2字节序列（0x7D、0x5E）
2. 若信息字段中出现一个0x7D字节，则把0x7D转变为2字节序列（0x7D、0x5D）
3. 若信息字段中出现ASC码的控制字符（即数值小于0x20字符），则在该字符前要加入一个0x7D字节，同时将该字符的编码加以改变。

**零比特填充**：
PPP协议用在SONET/SDH链路时，使用同步传输（一连串的比特连续传送），而不是异步传输（逐个字符传送）。在这种情况下，PPP协议采用零比特填充方法来实现透明传输。
具体为在发送端先扫面整个信息字段，若发现5个连续的1，则立即填入一个0，保证不会出现6个连续的1。接收端接收到一个帧后，找到帧定界再将之前向其中填充的0删掉，还原出原本的帧。

<img src="D:\Project\IT notes\计算机网络\img\零比特填充.png" style="width:700px;height:300px;" />

**PPP协议工作过程**：

![PPP协议工作过程](https://img1.baidu.com/it/u=1762460902,1846196560&fm=253&fmt=auto&app=120&f=PNG?w=500&h=334 "PPP协议工作过程")

***物理链路建立***：PPP链路的起始和终止状态都为“链路静止”，这时用户个人电脑和ISP路由器都不存在物理层连接。当用户个人电脑通过调制解调器呼叫路由器时，路由器检测到调制解调器的载波信号。双方建立了物理层连接后，PPP就进入“链路建立”的状态。
***LCP链路建立***：这时LCP开始协商配置选项，发送LCP的配置请求帧（PPP帧，协议字段为LCP对应代码，信息字段包含特定的配置请求）。LCP配置选项包含链路上的最大帧长、所使用的鉴别协议等
（LCP配置协商帧包含配置确认帧、配置否认帧、配置拒绝帧）
***LCP链路鉴别***：LCP协商结束后双方建立起LCP链路，需要进入鉴别状态，只允许传送LCP协议分组、鉴别协议的分组以及监测链路质量的分组。（此处鉴别协议包含口令鉴别PAP、口令握手鉴别CHAP等身份鉴别协议）
***NCP链路建立***：NCP根据网络层不同协议互相交换网络层特定的网络控制分组（若PPP链路上运行IP协议，则对PPP链路的每一端配置IP协议模块时使用NCP中支持IP的协议，如IPCP）。网络层配置完毕链路进入打开的状态。
***链路关闭***：数据传输结束后，链路的一段发出终止请求LCP分组关闭链路连接，在收到终止确认LCP分组后，进入“链路终止”状态。

## 5.广播信道协议CSMA/CD
<img src="D:\Project\IT notes\计算机网络\img\局域网拓扑.png" style="width:700px;height:500px;" />

局域网的共享信道分为两种：
1. 静态划分信道：频分复用、时分复用、波分复用、码分复用等
2. 动态媒体接入控制（多点接入）：信道并非在用户通信时固定分配给用户，有两大类：
- **随机接入**：所有用户随机发送信息。恰巧两个或更多的用户在同一时刻发送信息，则在共享信道媒体上会出现碰撞（冲突）。
- **受控接入**：用户不能随机发送信息而必须服从一定安排，如分散控制的令牌环局域网、集中控制的多点线路探询（轮询）

网络适配器：

<img src="D:\Project\IT notes\计算机网络\img\网络适配器.png" style="width:600px;height:200px;" />

网络适配器又称网卡，装有处理器和存储器（RAM和ROM）。适配器和局域网之间的通信通过电缆或双绞线以串行传输，适配器与计算机之间的通信通过主板IO总线以并行传输。因此适配器需要对串行与并行两种传输方式进行转换（RAM存在的原因之一）。
当适配器接收到差错帧则丢弃而不通知计算机，接收到正确帧则通过中断告知计算机并将帧上交网络层。当计算机发送IP数据报则把IP数据报封装成帧交由适配器发送。

**以太网特点**：
为了通信简便，以太网采用以下两种措施：
1. 采用无连接工作方式，不建立连接直接发送数据，对发送的数据帧不进行编号，不要求对方确认，尽最大努力交付，对差错帧则丢弃。差错校验由高层协议决定。
2. 由于使用了总线连接各计算机，因此协调各计算机的冲突成为关键，使用载波监听多点接入/碰撞检测（CSMA/CD）协议解决冲突。
3. 以太网使用曼切斯特编码，方便把位同步信息提取出来。

**CSMA/CD协议**：
多点接入：以太网为总线型网络，计算机以多点接入的方式接入总线
载波监听：不管在发送前中后，以太网中的每个站点检测总线信道信号，若存在其他站点发送载波，则推迟发送直至信道空闲。
碰撞检测：边发送边监听信道上的信号变化，若出现总线信道上的信号叠加（两台或以上数量的站点发送信号，信号在总线上出现碰撞，产生冲突），则适配器立即停止发送，推迟发送时机等待信道空闲。

![传播时延对载波监听的影响](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1043829%2F201905%2F1043829-20190503213338354-1995063071.png&refer=http%3A%2F%2Fimg2018.cnblogs.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1646141969&t=bab3b64a8716f3cde8f910f83309682c "传播时延对载波监听的影响")

每一个站点发送数据后的一段时间内都有可能发生碰撞（传输时碰撞），发送数据帧后至多经过时间2t发生碰撞，因此以太网端到端往返时间2t为**争用期**，也称**碰撞窗口**。经过争用期时间还没检测到碰撞则可以肯定此次发送不会发生碰撞。

**截断二进制指数退避**：让发生碰撞的站点在停止发送数据后，不是等待信道变为空闲立马发送数据，而是作出一定规律的推迟发送。重传推后时间为r倍的争用期，r为2的k次方减1，k为重传次数与10之间的较小值。（当重传次数超过10小于16则k一直等于10，若重传16次仍不能成功则丢弃帧向上层协议汇报）

若发送站发送一个短帧，发送完毕前无碰撞，信道上该帧在传送至目的站点之前和别的站点发送的帧发生碰撞，而目的站点检测到差错帧并丢弃该帧。但发送站点并无检测到碰撞因此不会重传。
鉴于以上情况，以太网规定最短帧长为64字节（信息字节少于64则使用填充字符填充至64字节）。

**总结以上条件，以太网发送数据时，如果在争用期（发送64字节）没有发生碰撞，那么后续发送的数据一定不会发生冲突。如果发送出去的数据小于64字节则可以判断都是因为冲突导致发送中断的异常帧，需丢弃。
（强化碰撞：一旦发送碰撞，除停止发送数据还要再继续发送32比特或48比特的强化干扰信号，让所有站点都知道已经发生了碰撞）
（帧间最小间隔为96比特时间）**

**CSMA/CD要点归纳：**
1. 适配器从网络层获得一个分组，加上以太网首部尾部封装成帧后放入适配器的缓存中。但在发送前必须检测信道。
2. 若信道忙则一直检测；若信道空闲，并在紧接着的96比特（帧间最小间隔）内仍然保持空闲，则发送帧。
3. 在发送期间不断检测信道，若一直未发生碰撞则发送成功。
4. 若在发送期间发生碰撞则中断发送，首先发送人为干扰信号，后执行退避算法。
（以太网每发送完一帧，则会把该帧缓存在RAM中，若发送冲突，可用于后面的重传）

## 6.以太网MAC层
MAC地址：48位全球地址，固化在网络适配器ROM中的地址。
网络适配器拥有过滤功能，会检测到来的MAC帧中的地址是否为自己的MAC地址，若不是则不做任何处理。是则收入。
（路由器可同时拥有多个接口以及标志接口地址的MAC）
发送至本站的MAC帧可包含以下三种：单播、广播、多播。
适配器还有一种***混杂方式***的工作机制。

MAC帧格式：

<img src="D:\Project\IT notes\计算机网络\img\MAC帧格式.png" style="width:700px;height:300px;" />

## 7.在数据链路层拓展以太网（以太网交换机）
网桥：对收到的MAC帧中的目的地址进行转发和过滤。当网桥收到一个帧时，根据网桥中的地址表，确定该帧的转发目的接口。
交换机：相当于多接口网桥。多接口，接口与主机或交换机相连，具有全双工通信方式，具有缓存。
交换机的自我学习功能：会记录每一次帧转发的源接口（目的接口）与MAC帧源MAC地址（目的MAC地址）的映射关系，存入交换表

## 8.虚拟局域网
![虚拟局域网](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F12560647%2F1622356395875-364f2450-b0d4-4ae0-a5fc-b5b2b26ce72f.png&refer=http%3A%2F%2Fcdn.nlark.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1646144782&t=e5510dcb6101a5faf447701a9ed40ccc "虚拟局域网")

![虚拟局域网帧格式](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fs5.51cto.com%2Foss%2F202002%2F18%2F601d2d8563dc78cf071603b8e45528b6.jpeg&refer=http%3A%2F%2Fs5.51cto.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1646144824&t=885ee3f9c5f2809be3c1a07c1e69e30d "虚拟局域网帧格式")
