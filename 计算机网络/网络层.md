## 1. 网际协议IP
![IP协议以及相关协议](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimages1.tqwba.com%2F20200313%2F3sm5f3d5pl2.png&refer=http%3A%2F%2Fimages1.tqwba.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1646554877&t=37498e6c8616e73e1494cc7f951c9e69 "IP协议以及相关协议")

与IP协议配套使用的协议有：
1. ARP地址解析协议
2. ICMP网际控制报文协议
3. IGMP网际组管理协议
4. RARP逆地址解析协议

## 2. 虚拟互连网络
将网络互相连接在一起的中间设备根据协议层次划分可分为：
1. 物理层：转发器
2. 数据链路层：网桥、桥接器（以太网交换机）
3. 网络层：路由器
4. 网络层以上：网关

![实际互连网络与虚拟互连网络](https://img1.baidu.com/it/u=1063785461,94366154&fm=253&fmt=auto&app=138&f=JPEG?w=499&h=267 "实际互连网络与虚拟互连网络")

## 3. IP地址
### 1. 传统IP地址分类
IP地址就是给互联网上的每一台主机（或路由器）的网络接口分配的唯一一个32位逻辑地址。
IP地址起初的分类方法为使用固定长度的字段分别表示网络号以及主机号。（网络号在所属的网络范围内是唯一的，主机号在网络号指定的网络范围内也是唯一的）
***IP地址：<网络号>,<主机号>***

![五类IP地址](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fgss0.baidu.com%2F94o3dSag_xI4khGko9WTAnF6hhy%2Fzhidao%2Fpic%2Fitem%2Ffc1f4134970a304e75e4cc4ddcc8a786c8175c46.jpg&refer=http%3A%2F%2Fgss0.baidu.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1646558418&t=0b4f8cf473d21d13a8790f4da7124887 "五类IP地址")

A、B、C类地址网络号字段前存在若干位类别位，数值分别为0、10、110，其网络号长分别为1、2、3字节，其主机号长分别为3、2、1字节。（当某个单位申请到一个IP地址，实际上是获得一个网络号的地址，可自行分配该网络号中的主机号地址）

**A类地址：**
1. 网络号全0的IP地址为保留地址，表示本网络主机。
2. 网络号为127（二进制为01111111）保留作为本地软件环回测试本主机的进程之间的通信之用。若主机发送一个目的地址为127.0.0.1的IP数据报，则主机中的协议软件就处理数据报中的数据，不会发送至网络。
3. 主机号为全0的IP地址表示该主机所连接的单个网络地址。主机号为全1的IP地址表示该网络的全部主机。

**B类地址：**
1. B类可指派**最小**网络号为128.1.0.0，主机号为全0或全1的作用与A类地址主机号相同。

**C类地址：**
1. C类可指派**最小**网络号为192.0.1.0，主机号为全0或全1的作用与A类地址主机号相同。

![IP地址指派范围](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimgsa.baidu.com%2Fexp%2Fw%3D500%2Fsign%3Dc4177f23f4dcd100cd9cf821428a47be%2F43a7d933c895d143529b310d7ff082025aaf072b.jpg&refer=http%3A%2F%2Fimgsa.baidu.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1646560525&t=11825466bd9a91116daa70b96bc07fd3 "IP地址指派范围")

![特殊IP地址](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg-blog.csdnimg.cn%2F20210609084552840.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTMwNDUwMw%3D%3D%2Csize_16%2Ccolor_FFFFFF%2Ct_70&refer=http%3A%2F%2Fimg-blog.csdnimg.cn&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1646560601&t=16f26c3bd63c76b0c570f5a72ebd8587 "特殊IP地址")

**IP地址特点：**
1. 每一个IP地址都由网络号和主机号两部分组成；路由器仅根据目的主机所连接的网络号来转发分组。
2. IP地址标志一台主机和一条链路的接口。路由器具有多个网络接口，每个网络接口具有不同的IP地址。
3. 所有网络号代表的网络相互平等。

![互联网中的IP地址](https://img2018.cnblogs.com/blog/795254/201911/795254-20191116153957097-1582047834.png "互联网中的IP地址")

### 2. IP地址与硬件地址
物理地址是数据链路层和物理层使用的地址；IP地址是网络层和更高层协议使用的逻辑地址。
***发送***：数据从高层下到低层，然后才到通信链路上传输。使用IP地址的IP数据报一旦下交到数据链路层，就被封装成MAC帧。MAC帧在传送时使用的源地址和目的地址都为硬件地址，硬件地址都写在MAC帧的首部中。
***接收***：收到MAC帧后，根据MAC帧首部中的硬件地址决定收下或丢弃。只有在剥去MAC帧中的首部和尾部后把MAC层的数据上交给网络层后，网络层才能在IP数据报的首部中找到IP地址和目的IP地址。

![不同协议层的源地址与目的地址](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic2.zhimg.com%2Fv2-51c977cb12c3f3a7ef64d8347344285d_r.jpg&refer=http%3A%2F%2Fpic2.zhimg.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1646562291&t=040fe4ed9cc2ef9031a8f2387fbd16b7 "不同协议层的源地址与目的地址")

1. 在IP协议层的通信链路以及结点上只能看到IP数据报，即使经过路由器转发，数据报中的源IP地址与目的IP地址由始至终不变，路由器根据目的IP地址网络号进行转发。
2. 在数据链路层，MAC帧中的源MAC地址与目的MAC地址会于每一次存储转发的前后发生变化。

### 3. ARP协议
用途：从网络层使用的IP地址解析出在数据链路层使用的硬件地址。
（RARP逆地址解析：从硬件地址通过该协议找出IP地址）

每一台主机都设有一个ARP高速缓存，里面有**本局域网**上各主机和路由器的IP地址到硬件地址的映射表。

ARP协议运行过程：
1. 当主机A向本局域网的主机B发送IP数据报时，就先在主机A的ARP高速缓存中查看有无主机B的IP地址。如有，则将ARP缓存中主机B的IP地址对应的MAC地址取出，并写入MAC帧中。
   若ARP缓存中无该IP地址项，则有可能主机B刚刚入网、主机A刚加电，主机A则继续按照一下步骤运行ARP
2. 主机A的ARP进程在本局域网上广播发送一个ARP请求分组，主要内容为“本机IP地址为xxx，MAC地址为xxx；目的主机IP地址为xxx”
3. 本局域网上主机的ARP进程均收到该ARP请求分组，若存在某台主机的IP地址与该分组中的目的IP地址相同，则接收该ARP分组，把主机A的IP地址-MAC地址映射关系写入自己的ARP缓存中，并发出响应分组，告诉主机A请求的IP地址所对应的MAC地址
4. 主机A接收响应分组成功后，则将请求得到的IP地址-MAC地址映射关系存入本机的ARP高速缓存中
5. 重复第一步

注意：
1. ARP项存在生存时间，方便局域网更新主机
2. ARP协议只针对本局域网，若存在两台通信主机不在同一局域网中，则需要与源主机在同一局域网中的某一路由器转发，即向路由器发出ARP请求分组，获取ARP响应，将IP数据报发送至路由器以便转发至另一局域网

### 4. IP数据报格式

![IP数据报格式](https://img0.baidu.com/it/u=3373872303,285378341&fm=253&fmt=auto&app=138&f=JPG?w=690&h=442 "IP数据报格式")

1. 版本：指IP协议版本
2. 首部长度：首部长度字段所表示数的单位为4字节
3. 区分服务：服务类型
4. 总长度：指首部和数据之和的长度，单位为字节
5. 标识：当数据报由于长度超过MTU而必须进行分片时，这个标识字段的值就被复制到所有的数据报片的标识字段中，相同的标识字段的值使分片后的各数据报片最后能正确重装为原来的数据报
6. 标志：该字段最低位为MF，为1则表示后面还有分片，为0则表示已是最后一块分片；该字段中间一位为DF，为0允许分片，为1不允许分片
7. 片偏移：指出较长的分组在分片后，某片在原分组中的相对位置，以8字节为单位
8. 生存时间：TTL，每经过一个路由器减1，直至为0
9. 协议：指出数据报携带数据使用的是哪种协议
10. 首部校验和：只校验数据报首部，不包括数据部分
11. 源地址
12. 目的地址
13. 可变部分

### 5. IP层转发分组流程
在路由表中，对每一条路由最主要的是以下两个信息：**目的网络地址，下一跳地址**，根据目的网络决定下一跳地址

![转发分组流程](https://img0.baidu.com/it/u=3423989740,1244298139&fm=253&fmt=auto&app=138&f=JPEG?w=420&h=293 "转发分组流程")

![转发分组流程](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimage.bubuko.com%2Finfo%2F201911%2F20191121210405293712.png&refer=http%3A%2F%2Fimage.bubuko.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1646820408&t=07c205b079e55110135027f48ec312f3 "转发分组流程")

注意：
1. IP数据报最终一定可以找到目的主机所在的目的网络
2. 只有到达最后一个路由器时，才试图向目的主机进行直接交付
3. 虽然大多数分组转发都基于目的主机所在的网络，但也存在对特定目的主机指明一个路由，该路由称作特定主机路由，用于测试网络
4. 路由器还采用默认路由以达到减小路由表占用空间以及搜索路由表使用的时间
5. 当路由器获取到一个待转发的数据报时，会根据目的IP地址从路由表获取下一跳地址，后在ARP缓存中得到下一跳地址对应的MAC地址，将目的MAC地址写入数据链路层的目的地址，才进行数据报的转发。

### 6. 划分子网与构造超网
#### 1. 划分子网
由于IP地址空间利用率时而低下，以及两级IP地址不够灵活，因此增加子网号字段划分出子网，成为3级IP地址。
特点：将单个网络划为多个子网，对内可见，对外透明；从网络主机号借用若干位成为子网号；IP数据报根据网络号寻找到目的网络，再根据子网号以及主机号寻找所属子网以及主机

**将IP数据报中的目的IP地址与子网掩码进行逐位“与”运算，得到的结果就是所要找的子网网络地址，将该子网网络地址与路由表中的目的网络地址相比较，若相同则将数据报路由至此网络中。
（划分子网后，路由表包含三项内容：目的网络地址、子网掩码、下一跳地址）**

![子网掩码](https://img1.baidu.com/it/u=527107425,1906141030&fm=253&fmt=auto&app=138&f=PNG?w=1077&h=488 "子网掩码")

#### 2. 无分类编址（构造超网、无分类域间路由选择CIDR）
特点：
1. 消除传统A、B、C类地址以及划分子网的概念，使IP地址重新回到两级地址，IP地址由网络前缀以及主机号构成。
2. CIDR将相同网络前缀的连续IP地址称为CIDR地址块。
3. CIDR使用32位的地址掩码，作为子网掩码。

在使用CIDR时，由于采用网络前缀的记法，IP地址由网络前缀以及主机号组成，因此路由表中的每一项由网络前缀以及下一跳地址著称。**但可能会出现多个匹配结果，因此规定应当从匹配结果中选择具有最长网络前缀的路由。**

**二叉线索查找路由表**

## 4. 网际控制报文协议ICMP
ICMP允许主机或路由器报告差错情况和提供有关异常情况的报告。

![ICMP报文格式](https://img2.baidu.com/it/u=543194218,1185013062&fm=253&fmt=auto&app=138&f=GIF?w=380&h=200 "ICMP报文格式")

ICMP报文类型：差错报告报文、询问报文

![ICMP报文类型](https://img2.baidu.com/it/u=398297468,2130739180&fm=253&fmt=auto&app=138&f=PNG?w=860&h=337 "ICMP报文类型")

ICMP差错报告报文共有四种：
1. 终点不可达：当路由器或主机不能交付数据报时就向源点发送终点不可达报文
2. 时间超过：当路由器收到TTL为0的数据报或未完全收到一个数据报时，除丢弃该数据报，还向源点发送时间超过报文
3. 参数问题：路由器或主机收到数据报首部中某些字段值不正确
4. 改变路由（重定向）：路由器把改变路由报文发送给主机，通知主机下次发送给另外的路由器

![ICMP差错报文格式](https://img2.baidu.com/it/u=3873226813,4071320713&fm=253&fmt=auto&app=138&f=JPEG?w=988&h=500 "ICMP差错报文格式")

不应发送ICMP差错报文的情况：
1. 不再对ICMP差错报告报文发送ICMP差错报告报文
2. 对除某IP数据报第一分片的其他分片不再发送差错报告报文
3. 不对具有多播地址的IP数据报发送差错报告报文
4. 不对具有特殊地址（127.0.0.0、0.0.0.0）的IP数据报发送差错报告报文

ICMP询问报文类型：
1. 回送请求和回答：主要测试源站点到目的站点间的链路状态
2. 时间戳请求和回答：主要用于时钟同步或时间测量

ICMP重要应用：
1. PING，使用ICMP回送请求与回送回答报文，是应用层直接使用网络层ICMP的一个例子，并无经过TCP或UDP
2. traceroute：跟踪分组从源点到目的点的路径

## 5. 内部网关协议与外部网关协议
互联网采用路由选择协议主要为自适应、分布式路由选择协议。可以把整个互联网划分为许多较小的自治系统AS（在单一技术管理下的一组路由器，这些路由器使用一种自治系统内部的路由选择协议和共同的度量）
互联网可把路由选择协议分为两大类：
1. 内部网关协议IGP（域内路由选择）：一个自治系统内部使用的路由协议，与其他自治系统使用的路由协议无关，RIP、OSPF使用较多
2. 外部网关协议EGP（域间路由选择）：当数据报传至自治系统边缘，就需要一种协议将路由选择信息传递到另一个自治系统中，BGP使用较多

#### 1. 内部网关协议RIP
RIP是一种分布式的基于距离向量的路由选择协议，RIP协议要求网络中的每一个路由器都要维护从自己到其他每一个目的网络的距离记录（RIP不能在两个网络之间同时使用多条路由，只能选择一条具有最少路由器的路由）

RIP协议特点：
1. 仅和相邻路由器交换信息，不相邻则不交换信息
2. 路由器交换的信息为自己路由表中的所有信息，即本路由器到该自治系统中的所有网络的最短距离，以及到每个网络应经过的下一跳路由器
3. 按固定时间间隔交换路由信息

路由表中最主要的信息是到某个网络的距离（最短距离），以及应经过的下一跳地址。路由表更新的原则是找出到每个目的网络的最短距离。因此这种更新算法也称为距离向量算法

RIP使用的距离向量算法：
对每一个相邻路由器发送过来的RIP报文，进行以下步骤：
1. 对地址为X的相邻路由器发来的RIP报文，先修改此报文中的所有项目：把“下一跳”字段中的地址改为X，并把所有的“距离”字段值加1。每一个项目都有三个关键数据，即：到目的网络N，距离D，下一跳路由器X。
2. 对修改后的RIP报文中的每一个项目，进行以下步骤：
	- 若原来的路由表中没有目的网络N，则把该项目添加到路由表中
	- 否则
		- 若下一跳路由器地址是X，则把收到的项目替换原路由表中的项目
		- 否则
			- 若收到的项目中的距离d小于路由表中的距离，则进行更新
			- 否则什么都不做
3. 若3分钟还没有收到相邻路由器的更新路由表，则把此路由器记为不可达的路由器，距离设置为16
4. 返回

RIP报文格式：

![RIP报文格式](https://img0.baidu.com/it/u=1018207842,3060145899&fm=253&fmt=auto&app=138&f=JPG?w=499&h=276 "RIP报文格式")

#### 2. 内部网关协议OSPF
OSPF协议最主要特征为使用分布式的链路状态协议，与RIP协议相比，由三个不同的要点：
1. 向本自治系统中所有路由器发送信息，使用**洪泛法**，即所有路由器通过所有输出端口向所有相邻路由器发送信息，相邻路由器同样以该方式向其他相邻路由器发送信息，最终所有路由器得到交换信息的副本
2. 发送的信息为与本路由器相邻的所有路由器的链路状态（代价），状态（代价）的含义可有管理员规定，可为费用、距离、时延、带宽等
3. 只有网络拓扑发生变化路由器才相互之间更新信息
4. 到同一网络存在多条路由，可实现多路由的负载均衡，合理分配通信量

由于各路由器之间频繁交换链路状态信息，因此所有路由器最终都能建立一个**链路状态数据库**，实际是全网的拓扑结构图。每个路由器都知道全网共有多少个路由器、哪些路由器相连、代价为多少。路由器使用链路状态数据库构建自己的路由表。

OSPF报文格式：

![OSPF报文格式](https://upload-images.jianshu.io/upload_images/23835871-0460eba3a1d0c68f.png?imageMogr2/auto-orient/strip|imageView2/2/w/1158/format/webp "OSPF报文格式")

OSPF五种类型分组：
1. 问候分组，用来发现和维持邻站的可达性
2. 数据库描述分组，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息
3. 链路状态请求分组，向对方请求发送某些链路状态项目的详细信息
4. 链路状态更新分组
5. 链路状态确认分组

<img src="D:\Project\IT-notes\计算机网络\img\OSPF基本操作.png" style="width:700px;height:400px;" />

![OSPF更新链路状态](https://img1.baidu.com/it/u=2841124811,764456307&fm=253&fmt=auto&app=138&f=JPEG?w=499&h=231 "OSPF更新链路状态")

#### 3. 外部网关协议BGP
BGP采用**路径向量路由选择协议**，与RIP距离向量协议、OSPF链路状态协议有很大区别
在配置BGP时，每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“BGP发言人”。一般两个BGP发言人都是通过一个共享网络连接在一起，BGP发言人往往就是BGP边界路由器，也可以不是。

一个BGP发言人与其他AS的BGP发言人要交换路由信息，就要先建立TCP连接，然后在此连接上交换BGP报文以建立BGP会话，利用BGP会话交换路由信息。所交换的路由信息是网络可达性，即要到达某个网络所要经过的一系列自治系统。当BGP发言人相互交换了网络可达性的信息后，各BGP发言人根据采用的策略从收到的路由信息中找出到达各自治系统的较好路由。

BGP交换路由信息的结点数量级是自治系统个数的量级，比如通知其他自治系统到某个网站所要经过的自治系统路径。（BGP刚刚运行时，BGP的邻站是交换整个BGP路由表，但以后只需要在发生变化时更新有变化的部分，这样可节省网络带宽和减少路由器的处理开销方面都有好处）

BGP四种报文：
1. OPEN打开报文：与相邻的另一个BGP发言人建立关系，使通信初始化
2. UPDATE更新报文：通告某一路由的信息，以及列出要撤销的多条路由
3. KEEPALIVE保活报文：周期性证实邻站的连通性
4. NOTIFICATION通知报文：发送检测到的差错

![BGP协议报文格式](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg-blog.csdnimg.cn%2F20190507161728845.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwNDUyMzE3%2Csize_16%2Ccolor_FFFFFF%2Ct_70&refer=http%3A%2F%2Fimg-blog.csdnimg.cn&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1646898232&t=ce85ca8176b296a84e23bcecb0f8bd3b "BGP协议报文格式")

## 6. 路由器构成

![路由器结构](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.51wendang.com%2Fpic%2Fda17c12f52cc010eba6db8ea%2F4-810-jpg_6-1080-0-0-1080.jpg&refer=http%3A%2F%2Fwww.51wendang.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1646898435&t=54b19ebaabc07ddcb2c44e72ff8b1799 "路由器结构")

## 7. IPv6
IPv4向IPv6过渡的方法有两种：双协议栈、隧道技术

![双协议栈](https://img1.baidu.com/it/u=3805937009,1097097275&fm=253&fmt=auto&app=138&f=JPEG?w=957&h=500 "双协议栈")

![隧道技术](https://img1.baidu.com/it/u=879524363,1560291808&fm=253&fmt=auto&app=138&f=PNG?w=736&h=483 "隧道技术")

## 8.  IP多播
### 1. 多播概念
![IP多播](https://img2.baidu.com/it/u=796258914,4037527370&fm=253&fmt=auto&app=138&f=PNG?w=854&h=500 "IP多播")

与单播相比，在一对多的通信中，多播可以大大减少网络资源。在互联网上进行多播就叫做**IP多播**，IP多播所传送的分组需要使用多播IP地址。能够运行多播协议的路由器叫做**多播路由器**，当然多播路由器也可以转发普通的IP数据报。

在互联网中的每一台主机都必须有一个全球唯一的IP地址，如果某台主机现在想接受某个特定多播组的分组，那么怎样才能使这个多播数据报传送到这台主机呢？

其实多播组的标识符就是 IP 地址中的 D 类地址。D 类 IP 地址的前四位是 1110，因此D 类地址范围是 224.0.0.0 到 239.255.255.255。我们就用每一个 D 类地址标志一个多播组。这样，D 类地址共可标志 2的28次方 个多播组，也就是说，在同一时间可以允许有超过 2.6 亿的多播组在互联网上运行。多播数据报也是“尽最大努力交付”，不保证一定能够交付多播组内的所有成员。因此，多播数据报和一般的IP数据报的区别就是它使用D类IP地址作为目的地址，并且首部中的协议字段值是2，表明使用网际组管理协议IGMP。

显然，**多播地址只能用于目的地址，而不能用于源地址**。此外，对多播数据报不产生ICMP 差错报文。因此，若在 PING 命令后面键入多播地址，将永远不会收到响应。

IP多播可以分为两种：在局域网上进行硬件多播和在互联网范围进行多播

### 2. 在局域网上进行硬件多播
互联网号码指派管理局 IANA 拥有的以太网地址块的高 24 位为 00-00-5E, 因此 TCP/IP协议使用的以太网多播地址块的范围是从00-00-5E-00-00-00到00-00-5E-FF-FF-FF。在第3章讲过，以太网硬件地址字段中的第 1 字节的最低位为 1 时即为多播地址，这种多播地址数占 IANA 分配到的地址数的一半。因此 IANA 拥有的以太网多播地址的范围是从01-00-5E-00-00-00到01-00-5E-FF-FF-FF。不难看出，在每一个地址中，只有23位可用作多播。这只能和D类IP 地址中的23位有一一对应的关系。D类 IP 地址可供分配的有 28 位，可见在这 28 位中的前 5 位不能用来构成以太网硬件地址（图 4-54）。例如，IP 多播地址224.128.64.32（即 E0-80-40-20）和另一个 IP 多播地址 224.0.64.32（即 E0-00-40-20）转换成以太网的硬件多播地址都是 01-00-5E-00-40-20。由于多播 IP 地址与以太网硬件地址的映射关系不是唯一的，因此收到多播数据报的主机，还要在 IP 层用软件进滤，把不是本主机要接收的数据报丢弃。

### 3. 网际组管理控制协议IGMP和多播路由选择协议
#### 1. 网际组管理控制协议IGMP
从概念上讲，IGMP的工作可分为两个阶段：
1. 当某台主机加入新的多播组时，该主机应向多播组的多播地址发送一个IGMP报文，声明自己要成为该组成员。本地的多播路由器收到IGMP报文后还要利用多播路由选择协议把这种组成员关系转发给互联网上的其他多播路由器
2. 组成员关系是动态的，本地多播路由器要周期性探询本地局域网上的主机，以便知道这些主机是否还继续是组的成员。只要一台主机对某个组响应，那多播路由器则认为该组活跃。若存在若干次探询某个组无一台主机响应，则认为该组的主机已全部离组，本地多播路由器不再向其他路由器交换该组成员信息

IGMP采用的一些具体措施：
1. 主机和多播路由器之间的所有通信都是使用IP多播。只要有可能，携带IGMP报文的数据报都用硬件多播来传送。因此在支持硬件多播的网络上，没有参加IP多播的主机不会接收到IGMP报文。
2. 多播路由器在探询组成员关系时，只需要对所有的组发送一个请求信息的询问报文，而不需要对每一个组发送一个询问报文（虽然也允许对一个特定组发送询问报文）。默认的询问速率是每 125 秒发送一次（通信量并不太大）。
3. 当同一个网络上连接有几个多播路由器时，它们能够迅速和有效地选择其中的一个来探询主机的成员关系。因此，网络上多个多播路由器并不会引起IGMP通信量的增大。
4. 在 IGMP 的询问报文中有一个数值 N，它指明一个最长响应时间（默认值为 10秒）。当收到询问时，主机在 0 到 N 之间随机选择发送响应所需经过的时延。因此，若一台主机同时参加了几个多播组，则主机对每一个多播组选择不同的随机数。对应于最小时延的响应最先发送。
5. 同一个组内的每一台主机都要监听响应，只要有本组的其他主机先发送了响应，自己就可以不再发送响应了。这样就抑制了不必要的通信量。

多播路由器并不需要保留组成员关系的准确记录，因为向局域网上的组成员转发数据报是使用硬件多播。多播路由器只需要知道网络上是否至少还有一台主机是本组成员即可。实际上，对询问报文每一个组只需有一台主机发送响应。

如果一台主机上有多个进程都加入了某个多播组，那么这台主机对发给这个多播组的每个多播数据报只接收一个副本，然后给主机中的每一个进程发送一个本地复制的副本。最后我们还要强调指出，多播数据报的发送者和接收者都不知道（也无法找出）一个多播组的成员有多少，以及这些成员是哪些主机。互联网中的路由器和主机都不知道哪个应用进程将要向哪个多播组发送多播数据报，因为任何应用进程都可以在任何时候向任何一个多播组发送多播数据报，而这个应用进程并不需要加入这个多播组。

#### 2. 多播路由选择协议
虽然TCP/IP中IP多播协议已经成为了建议标准，但**多播路由选择协议**尚未标准化。

在多播过程中，一个多播组的成员是动态变化的。多播路由选择协议实际上是找出以源主机为**根节点**的**多播转发树**，在多播转发树上，每一个多播路由器向树的叶节点方向转发收到的多播数据报，但在多播转发树上的多播路由器上不会收到重复的多播数据报（即多播数据报不会在互联网中兜圈子）。不难看出，对于不同的多播组对应于不同的多播转发树，同一个多播组，对不同的源点也会有不同的多播转发树。

已有了多种实用的多播路由选择协议，它们在转发多播数据报的时候使用了以下三种方法：
1. **洪泛与剪除**：这种方法适用于较小的多播组，而所有的组成员接入的局域网也是相邻的。一开始，路由器转发多播数据报使用的是洪泛的方法（也就是广播）。为了避免兜圈子，采用了叫做**反向广播路径RPB（Reverse Path Broadcasting）的策略**。RPB的要点是：每一个路由器在收到一个多播数据报的时候，先检查数据报是否从源点经**最短路径**传来，进行这种检查很容易，只要从本路由器寻找到源点的最短路径上（之所以叫做反向路径，因为在计算最短路径的时候把源点当做终点）的第一个路由器是否就是刚才把多播数据报送来的路由器。若是，就向所有其他地方转发刚才收到的多播数据报（进入的方向除外），否则就丢弃而不转发。如果本路由器有好几个相邻路由器都处在源点的最短路径上（也就是说，存在多条同样长度的最短路径），那么只能选择一条最短路径，选择的转则是看这几条最短路径中谁的**IP地址最小**

	![洪泛与剪除](https://img2020.cnblogs.com/blog/2361214/202201/2361214-20220106120300180-438206795.png "洪泛与剪除")
	
	为了简单起见，在图4-57中的网络用路由器之间的链路来表示，我们假定各路由器之间的距离都是1。路由器R1在收到源点发来的多播数据报之后，向R2和R3进行转发。R2发现R1就在自己到源点的最短路径上，因此向R3和R4转发收到的多播数据报，R3发现R2不在自己的源点的最短路径上，因此丢弃R2发送过来的数据报。其他路由器也照样转发。R6到源点有两条最短路径：R7->R4->R2->R1->源点；R7->R5->R3->R1->源点。我们假定R4的IP地址比R5的IP小，所以我们只使用前一条最短路径。因此R7只转发R4发过来的IP数据报。而丢弃R5传过来的数据报。最后就得到了用来转发多播数据报的多播转发树（图中粗线），以后就按照这个多播转发树来转发多波数据报。这样就避免了多播数据报兜圈子问题。
	
	如果在多播转发树上的某个路由器发现它的下游树枝（即叶节点方向）已没有该多播组成员，就应该把它和下游的树枝**一起剪除**，例如，在图4-57中虚线椭圆表示剪除的部分，当某个树枝有新增加的组成员的时候，可以再接入到多播转发树上。
2. **隧道技术（tunneling）**：隧道技术适用于**多播组的位置在地理上很分散的情况**。例如在图4-58中，网1和网2都支持多播，现在网1的一些主机向网2的一些主机进行多播。但路由器R1和R2之间的网络并不支持多播，因而R1和R2路由器不能按多播地址进行转发数据报。为此。R1路由器就对多播数据报**进行再封装**，再加上普通数据报首部，使之成为一个向单一目的站发送的**单播(unicast)数据报**，然后通过**隧道(tunnel)**从R1发送到R2。

	![硬件多播](https://img2020.cnblogs.com/blog/2361214/202201/2361214-20220106120123414-1537659529.png "硬件多播")
	
	单播数据报到达路由器R2后，再由路由器R2剥去其首部，使之又恢复成原来的多播数据报，继续向多个目的站进行转发。使用隧道技术传送数据报又叫做IP中的IP（IP in IP）。
3. **基于核心的发现技术**：这种方法对于多播组的大小在较大范围内变化都合适。这种方法是对每一个多播组G指定一个**核心路由器**，给出它的IP单播地址。核心路由器按照前面讲过的方法创建出对应于多播组G的转发树。如果有一个路由器R1向这个核心路由器发送数据报，那么它在途中经过的每一个路由器都要检查其内容。当数据报到达参加了多播组G2的组地址时候，R2就向多播组G的成员转发这个多波数据报。如果R1发送的数据报是一个请求加入多播组G的数据报，R2就把这个信息加到它的路由中，并用**隧道技术**向R1转发每一个多播数据报副本。这样，参加组G的路由器就从核心向外增多了。扩大了多播转发树的范围。