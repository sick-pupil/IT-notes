## 1. 进程相关背景
1. 一个计算机平台包括一组硬件资源，比如处理器、内存、IO模块、定时器和磁盘驱动器等
2. 计算机程序是为执行某些任务而开发的，在典型的情况下，它们接收外来的输入，做一些处理之后，输出结果
3. 直接根据给定的硬件平台写应用程序效率低下
4. 开发操作系统是为了给应用程序提供一个方便、安全、一致的接口。操作系统是计算机硬件和应用程序之间的一层软件，对应用程序和工具提供支持
5. 可以把操作系统想象为资源的统一抽象表示，可以被应用程序请求和访问。资源包括内存、网络接口和文件系统等。一旦操作系统为应用程序创建这些资源的抽象表示，就必须管理它们的使用

## 2. 进程定义
1. 一个正在执行中的程序
2. 一个正在计算机上执行的程序实例
3. 能分配给处理器并由处理器执行的实体
4. 一个具有以下特征的活动单元：一组指令序列的执行、一个当前状态和相关的系统资源集

![进程控制块相关元素](https://img0.baidu.com/it/u=2933652839,3808213891&fm=253&fmt=auto&app=138&f=JPEG?w=538&h=500 "进程控制块相关元素")

![进程控制块相关元素](https://bkimg.cdn.bcebos.com/pic/500fd9f9d72a60596e71d6f82b34349b023bbaea?x-bce-process=image/resize,m_lfit,w_536,limit_1/format,f_jpg "进程控制块相关元素")

可以把进程视为一组元素组成的实体，基本元素是**程序代码**和代码相关**数据集**

进程由以下元素组成：
1. **标识符**：跟这个进程相关的唯一标识符，用来区别其他进程
2. **状态**：若进程运行，则进程为运行态
3. **优先级**：相对于其他进程的优先级
4. **程序计数器**：程序中即将被执行的下一条指令的地址
5. **内存指针**：包括程序代码和进程相关数据的指针，以及与其他进程共享内存块的指针
6. **上下文数据**：进程执行时处理器的寄存器中的数据
7. **IO状态信息**：包括显式的IO请求、分配给进程的IO设备和被进程使用的文件列表等
8. **记账信息**：可能包括处理器时间总和、使用的时钟数总和、时间限制、记帐号等

以上进程元素被存放在一个称为**进程控制块**的数据结构中，该控制块由操作系统创建和管理。进程切换时，操作系统会把处理器寄存器上下文、相应内存信息存放于被切换进程的进程控制块中，并修改其中的状态，之后读取切换出来的进程的进程控制块，将其中寄存器上下文写入处理器中，并代入新的程序计数器值，置新进程为运行态，最后运行新进程

## 3. 进程状态
### 1. 两状态模型
![两状态进程模型](https://www.likecs.com/default/index/img?u=aHR0cHM6Ly9waWFuc2hlbi5jb20vaW1hZ2VzLzYwMC8xOTIzMGIzMDc1ZDk0NTAzMjFkOWY5MGE0MDFmMmIzMC5wbmc= "两状态进程模型")

![两状态进程模型](https://www.likecs.com/default/index/img?u=aHR0cHM6Ly9waWFuc2hlbi5jb20vaW1hZ2VzLzQ2Ni8wNWNmMTdjOWEwYTg1MjA4YzU5ZWI1ODVhMjZkNTlkYS5wbmc= "两状态进程模型")

导致进程创建的原因：
1. 新的批处理作业：通常位于磁带或磁盘中的批处理作业控制流被提供给操作系统。当操作系统准备接纳新工作时，它将读取下一个作业控制命令
2. 交互登录：终端用户登录到系统
3. 操作系统因为提供一项服务而创建：操作系统可以创建一个进程，代表用户程序执行一个功能，使用户无须等待
4. 由现有的进程派生：基于模块化的考虑，或者为了开发并行性，用户程序可以指示创建多个进程

导致进程终止的原因：
1. 正常完成：进程自动执行一个操作系统服务调用，表示它已经结束运行
2. 超过时限：进程运行时间超过限定的时限
3. 无可用内存：系统无法满足进程需要的内存空间
4. 越界：进程试图访问不允许访问的内存单元
5. 保护错误：进程试图使用不允许使用的资源或文件、或者试图以一种不正确的方式使用
6. 算术错误
7. 时间超出：进程等待某一事件发生的时间超过规定的最大值
8. IO失败：输入或输出期间发生错误
9. 无效指令：进程试图执行一个不存在的指令
10. 特权指令：进程试图使用为操作系统保留的指令
11. 数据误用：错误类型或未初始化的一块数据
12. 父进程终止
13. 父进程请求

### 2. 五状态模型
![五状态进程模型](https://img1.baidu.com/it/u=2020665015,866800321&fm=253&fmt=auto&app=138&f=PNG?w=681&h=247 "五状态进程模型")

**运行态**：该进程正在执行。假设计算机只有一个处理器，因此一次最多只有一个进程处于这个状态
**就绪态**：进程做好了准备，只要有机会就开始执行
**阻塞/等待态**：进程在某些事件发生前不能执行
**新建态**：刚刚创建的进程，操作系统还未把它加入到可执行进程组中，通常是进程控制块已经创建但还没加载到内存中的新进程
**退出态**：操作系统从可执行进程组中释放出的进程

例：一位新用户试图登录到分时系统中，或者一个新的批处理作业被提交执行，那么操作系统可以分两步定义新进程。首先操作系统执行一些必需的辅助工作，将标识符关联到进程，分配和创建管理进程所需要的所有表。此时，进程处于新建态，这意味着操作系统已经执行了创建进程的必需动作，但还没有执行进程

例：操作系统可能基于性能或内存局限性的原因，限制系统中的进程数量。当进程处于新建态时，操作系统所需要的关于该进程的信息保存在内存的进程表中，但进程自身还未进入内存，就是即将执行的程序不在内存中，也没有为与这个程序相关的数据分配空间。当进程处于新建态时，程序保留在外存

例：当进程到达一个自然结束点，由于出现不可恢复的错误而取消时，或当具有相应权限的另一个进程取消该进程时，进程被终止，使进程转换到退出态，此时进程不再执行，与作业相关的表和其他信息临时被操作系统保留起来，这给辅助程序提供提取所需信息的时间。一旦完成提取，操作系统就不再保留任何与该进程相关的数据

![单阻塞进程队列](https://img0.baidu.com/it/u=2066129169,3246291714&fm=253&fmt=auto&app=138&f=JPEG?w=595&h=242 "单阻塞进程队列")

![多阻塞进程队列](https://img1.baidu.com/it/u=2023289709,4111903398&fm=253&fmt=auto&app=138&f=PNG?w=872&h=478 "多阻塞进程队列")

### 3. 挂起态进程
基于IO处理速度慢于处理器速度，导致可能会出现内存中多数为阻塞态进程，处理器空闲的情况，引入交换的解决方案：把内存中某个进程的一部分或全部移到磁盘中。当内存中没有处于就绪状态的进程时，操作系统就把被阻塞的进程换出到磁盘中的“挂起队列”，暂时保存从内存中被换出的进程。操作系统之后取出挂起队列中的另一个进程或者接收一个新进程的请求，并纳入内存运行

![有挂起状态的进程状态模型转换图](https://img1.baidu.com/it/u=847314968,2629949248&fm=253&fmt=auto&app=138&f=PNG?w=963&h=500 "有挂起状态的进程状态模型转换图")

**就绪态**：进程在内存中并可以执行
**阻塞态**：进程在内存中并等待一个事件
**阻塞/挂起态**：进程在外存中并等待一个事件
**就绪/挂起态**：进程在外存中，但是只要被载入内存就可以执行

挂起原因：
1. 交换：操作系统需要释放足够的内存空间，以调入并执行处于就绪态的进程
2. 其他OS原因
3. 交互式用户请求
4. 定时：进程可能会周期性执行，并等待下一个时间间隔时被挂起
5. 父进程请求

## 4. 进程描述
操作系统控制计算机系统内部的事件，为处理器执行进程而进行调度和分派，给进程分配资源，并响应用户程序的基本服务请求

操作系统为了管理进程和资源，必须掌握关于每个进程和资源当前状态的信息：操作系统构造并维护它所管理的每个实体的信息表：内存表、IO表、文件表、进程表

![操作系统控制表的通用结构](https://img1.baidu.com/it/u=1995547139,2020635449&fm=253&fmt=auto&app=138&f=JPEG?w=508&h=350 "操作系统控制表的通用结构")

**内存表**：用于跟踪内存（实存）和外存（虚拟内存）。内存的某些部分为操作系统保留，剩余部分是进程可以使用的，保存在外存中的进程使用某种类型的虚拟内存或简单的交换机制。内存表所包含信息：分配给进程的内存；分配给进程的外存；内存块或虚拟内存块的任何保护属性；管理虚拟内存所需要的任何信息

**IO表**：管理计算机系统中的IO设备和通道。在任何给定的时刻，一个IO设备或者是可用的，或者已分配给某个特定的进程

**文件表**：提供关于文件是否存在、文件在外存中的位置、当前状态和其他属性的信息，可由操作系统或者文件管理系统维护和使用

**进程表**：内存、IO、文件是代表进程而被管理的，因此进程表中必须有对这些资源的直接或间接引用

### 1. 进程控制结构
进程映像：程序、数据、栈和属性的集合
进程控制块：属性的集合

![进程映像组成](https://upload-images.jianshu.io/upload_images/20574953-fec163a8c505d49b.png?imageMogr2/auto-orient/strip|imageView2/2/w/732/format/webp "进程映像组成")

进程映像中典型的元素：
1. 用户数据
2. 用户程序
3. 系统栈
4. 进程控制块

现代操作系统假定分页硬件允许用不连续的物理内存来支持部分常驻内存的进程。在任何给定的时刻，进程映像的一部分可以在内存中，剩余部分可以在外存中。因此操作系统维护的进程表必须表明每个进程映像中每页的位置

存在一个主进程表，每个进程在表中都有一个表项，每一项至少包含一个指向进程映像的指针，若进程映像包括多个块，则这个信息直接包含在主进程表中，或可以交叉引用内存表中的项

可以把进程控制块信息分成三类：
1. 进程标识信息
2. 进程状态信息
3. 进程控制信息

![进程控制块中的典型元素](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.pianshen.com%2Fimages%2F839%2F19f2b83a33fefe57273ee8d79957b0ff.png&refer=http%3A%2F%2Fwww.pianshen.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1657973396&t=1747e77992143bee8c5c80df1f9ad446 "进程控制块中的典型元素")

<img src="D:\Project\IT-notes\操作系统\img\虚拟内存中的用户进程.png" style="width:500px;height:700px;" />

### 2. 执行模式
大多数处理器至少支持两种执行模式，某些指令只能在特权态下运行（读取改变程序状态字之类控制寄存器的值、原始IO指令），也存在一部分需要特权态下访问的内存区域；非特权态即用户态。使用两种模式可以保护操作系统和重要的操作系统表不受用户程序的干涉。通常程序状态字中有一位表示执行模式，这一位应某些事件的要求而改变

### 3. 进程创建
**创建新进程步骤**：
1. **给新进程分配一个唯一的进程标识符**，在主进程表增加一个新表项，表中的每个表项对应一个进程
2. **给进程分配空间**，这包括进程映像中的所有元素
3. **初始化进程控制块**
4. **设置正确的连接**
5. **创建或扩充其他数据结构**

### 4. 进程切换
进程执行的中断机制：
1. 中断：时钟中断、IO中断、内存失效
2. 陷阱
3. 系统调用

**模式切换**：在中断阶段中，处理器检查是否发生了任何中断，这通过中断信号来表示。如果没有未处理的中断，处理器继续取指令周期，即将当前进程中的下一条指令。如果存在一个未处理的中断，处理器需要做以下工作：
1. 把程序计数器置成中断处理程序的开始地址
2. 从用户态切换到内核态，使得中断处理代码可以包含有特权的指令

被中断的进程上下文保存在被中断程序的进程控制块中，上下文包含所有中断处理可能改变的信息和恢复被中断程序所需要的信息
中断处理程序通常是执行些与中断相关的基本任务的小程序：重置表示出现中断的标志或指示器；给产生中断的实体发送应答；检查错误条件并发送检查结果信号；时钟中断则是将控制移交给分派器，当分配的时间片用尽，分派器则将控制转移给另一个进程

**进程状态的变化**：模式切换与进程切换是不同的。发生模式切换可以不改变正处于运行态的进程状态，这种情况下开销小；**进程切换**步骤如下：
1. 保存处理器上下文环境，包括程序计数器和其他寄存器
2. 更新当前处于运行态进程的进程控制块，包括将进程的状态改变到另一状态，更新记账信息
3. 将进程的进程控制块移到相应的队列
4. 选择另一个进程执行
5. 更新所选择进程的进程控制块，包括更新进程状态
6. 更新内存管理的数据结构，这取决于如何管理地址转换
7. 恢复处理器在被选择的进程最近一次切换出运行态时的上下文环境，载入相关寄存器的值

### 5. 操作系统的执行
操作系统分为无进程的内核、在用户进程中执行、基于进程的操作系统

<img src="D:\Project\IT-notes\操作系统\img\操作系统与进程的历史关系.png" style="width:500px;height:500px;" />

<img src="D:\Project\IT-notes\操作系统\img\进程映像.png" style="width:400px;height:500px;" />
