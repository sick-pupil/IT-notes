## 1.  概述
**文件**的一些**理想属性**：
1. 长期存在
2. 可在进程间共享
3. 结构

**文件系统**不但提供存储数据的手段，而且提供一系列对文件进行操作的**功能接口**：
1. 创建
2. 删除
3. 打开
4. 关闭
5. 读
6. 写

文件通常会涉及以下四个术语
1. 域：基本数据单元，一个域包含一个值，长度可以是定长或者变长
2. 记录：一组相关域的集合，可视为应用程序的一个单元。同样，记录的长度也可以是定长的或变长的
3. 文件：一组相似记录的集合，被用户和应用程序视为一个实体，并可通过名字访问，文件有唯一的一个文件名。可被创建或删除
4. 数据库：一组相关的数据的集合，其本质特征是数据元素间存在着明确的关系，且可供不同的应用程序使用

**文件管理系统**是一组系统软件，它为使用文件的用户和应用程序提供服务。典型情况下，文件管理系统是用户或应用程序访问文件的唯一方式，可使得用户或程序员不需要为每个应用程序开发专用软件

<img src="D:\Project\IT notes\操作系统\img\文件系统软件架构.png" style="width:350px;height:300px;" />

**文件管理功能**
用户和应用程序通过使用创建文件、删除文件和执行文件操作的命令，来与文件系统进行交互。在执行任何操作之前，文件系统必须确认和定位所选择的文件。这要求使用某种类型的目录来描述所有文件的位置及它们的属性。用户和应用程序可以在文件上执行的基本操作是在记录级执行的。用户和应用程序把文件视为具有组织记录的某种结构。因此，要把用户命令转换成特定的文件操作命令，必须采用适合于该文件结构的访问方法

<img src="D:\Project\IT notes\操作系统\img\文件管理的要素.png" style="width:500px;height:300px;" />

虽然用户和应用程序关注的是记录，但IO是以块为基础来完成的，因此文件中的记录必须组织成一组块序来输出，并在输入后将各块组合起来。支持文件块IO需要许多功能。首先必须管理辅存，包括把文件分配到辅存中的空闲块，其次还需要管理空闲存储空间，以便知道新文件和现有文件增长时可以使用哪些块。此外，必须调度单个的块IO请求。磁盘调度和文件分配都会映像性能的优化，因此这些功能需要放在一起考虑

## 2. 文件组织和访问
文件组织指文件中记录的逻辑结构，它由用户访问记录的方式确定。文件在辅存中的物理组织取决于分块策略和文件分配策略

在选择文件组织时，有以下重要原则：
- 快速访问
- 维护简单
- 易于修改
- 可靠性
- 节约存储空间

已实现或提出的文件组织有多种：
- 堆
- 索引文件
- 顺序文件
- 直接或散列文件
- 索引顺序文件

<img src="D:\Project\IT notes\操作系统\img\常用文件组织.png" style="width:700px;height:300px;" />

### 堆
堆是最简单的文件组织形式。数据按它们到达的顺序被收集，每条记录由一串数据组成。堆的目的仅仅是积累大量的数据并保存。记录可以有不同的域，或者域相似但顺序不同
由于堆文件没有结构，因而对记录的访问是通过穷举查找进行的
当数据在处理前采集并存储时，或当数据难以组织时，会用到堆文件。当保存的数据大小和结构不同时，这种类型的文件空间使用情况很好

### 顺序文件
在顺序文件中，每条记录都使用一种固定的格式。所有记录都具有相同的长度，并由相同数量、长度固定的域按特定的顺序组成。由于每个域的长度和位置已知，因此只需保存每个域的值，每个域的域名和长度是该文件结构的属性

有一个特殊的域被称为关键域，关键域通常是每条记录的第一个域，它唯一表示这条记录

顺序文件通常用于批处理应用中，对于查询或更新记录的交互式应用，顺序文件的性能很差
典型情况下，顺序文件按照记录在块中的简单顺序存储，即文件在磁盘或磁带上的物理组织直接对应于文件的逻辑组织，对于更新操作：
1. 把新记录放到一个单独的堆文件中，称为日志文件或事务文件，通过周期性执行成批更新，把日志文件合并到主文件中，按关键字顺序产生一个新文件
2. 把顺序文件组织成链表的形式，一条或多条记录保存在每个物理块中，每个块含有指向下一块的指针

### 索引顺序文件
克服顺序文件的缺点，保留了顺序文件的关键特征，记录按照关键域的顺序组织，但增加了两个特征，用于支持随机访问的文件索引和溢出文件。索引提供快速接近目标记录的查找能力，溢出文件类似顺序文件中的日志文件

最简单的结构为只使用一级索引，文件中的每条记录由两个域组成：关键域和指向主文件的指针，其中关键域和主文件中的关键域相同。要查找某个特定的域，首先要查找索引，查找关键域值等于目标关键域值或者位于目标关键域值之前且最大的索引，然后在该索引的指针所指的主文件中的位置处开始查找

### 索引文件
当需要基于其他属性而非关键域查找一条记录时，可以采用多索引的结构，成为查找条件的每个域都可能有一个索引。因此对记录的放置位置不再有限制，只要至少有一个索引的指针指向这条记录即可

### 直接文件或散列文件
直接文件或散列文件开放直接访问磁盘中任何一个地址已知的块的能力。和顺序文件及索引顺序文件一样，每条记录都需要一个关键域
直接文件使用基于关键字的散列

## 3. B树

## 4. 文件目录
文件目录包含关于文件的信息，如属性、位置和所有权，文件目录自身是一个文件，它可被各种文件管理例程访问，用户和应用程序通过系统例程间接访问

<img src="D:\Project\IT notes\操作系统\img\文件目录的信息单元.png" style="width:700px;height:500px;" />

最简单的目录结构是一个目录项列表，每个文件都有一个目录项，这种结构可表示最简单的顺序文件，文件名用作关键字

可在文件目录上执行的操作类型有：
1. 查找：用户或应用程序引用一个文件时，必须查找目录，以找到该文件相应的目录项
2. 创建文件：创建一个新文件时，必须在目录中增加一个目录项
3. 删除文件：删除一个文件时，必须在目录中删除相应的目录项
4. 显示目录
5. 修改目录

<img src="D:\Project\IT notes\操作系统\img\树状结构目录.png" style="width:300px;height:300px;" />

<img src="D:\Project\IT notes\操作系统\img\树状结构目录示例.png" style="width:400px;height:600px;" />

## 5. 文件共享
多个用户间广泛共享文件提供灵活的工具。文件系统应提供一些选项，使得访问某个特定文件的方式能被控制。典型情况，用户或用户组被授予访问文件的某些权限：
1. 无：用户不知道文件的存在
2. 知道：用户可确定文件的存在并确定其所有者，向所有者申请更多的访问权限
3. 执行：用户可加载并执行一个程序，但不能复制
4. 读：用户能读文件，包括复制与执行
5. 追加：用户可给文件添加数据，但不能修改或删除
6. 更新：用户可修改、删除文件内容
7. 改变保护：用户可改变已授权给其他用户的访问权限
8. 删除：用户可从文件系统中删除文件

访问可提供给不同类型的用户：
1. 特定用户
2. 用户组
3. 全部

## 6. 记录组块
记录是访问结构化文件的逻辑单元，而块是与辅存进行IO操作的基本单元
对于给定的块大小，有三种组块方法：
1. 定长组块：使用定长的记录，且若干完整的记录保存在一个块中。每个块的末尾可能会有一些未使用的空间称为内部碎片
2. 变长跨越式组块：使用变长的记录，并紧缩到块中，使得块中不存在未使用的空间。因此某些记录会横跨两个块
3. 变长非跨越式组块：使用变长的记录，并不采用跨越方式。若下一条记录比块中剩余的未使用空间大，则无法使用这一部分

<img src="D:\Project\IT notes\操作系统\img\记录组块的方法.png" style="width:500px;height:500px;" />

## 7. 辅存管理
在辅存中，文件是由许多块组成。辅存中的空间必须分配给文件，必须知道哪些空间可用来进行分配
文件分配涉及的问题：
1. 创建一个新文件时，是否一次性给它分配所需的最大空间
2. 给文件分配的空间是一个或多个连续的单元，这些单元称为分区，分区是一组连续的已分配块。分区的大小可以从一个块大小到整个文件大小。分配文件时，分区大小应该是多少
3. 为跟踪分配给文件的分区，应使用哪种数据结构或表

**预分配和动态分配**
预分配策略要求在发出创建文件的请求时，声明该文件的最大尺寸，但使用动态分配只有在需要时才给文件分配空间

**分区大小**
1. 选择大小可变的大规模连续分区：能提供较好的性能，大小可变避免浪费，且使文件分配表较小，但又导致空间很难再次利用
2. 块：小的固定分区能提供更大的灵活性，但为了分配，可能需要较大的表或更复杂的结构

**首次适配**：从空闲块列表中选择第一个未被使用但大小足够的连续块组
**最佳适配**：选择大小足够但未使用过的块中的最小一个
**最近适配**：为提高局部性，选择与前面分配给该文件的块组最邻近的组

<img src="D:\Project\IT notes\操作系统\img\文件分配方法.png" style="width:400px;height:200px;" />

<img src="D:\Project\IT notes\操作系统\img\连续文件分配.png" style="width:700px;height:300px;" />

<img src="D:\Project\IT notes\操作系统\img\链式分配.png" style="width:700px;height:300px;" />

<img src="D:\Project\IT notes\操作系统\img\索引分配.png" style="width:700px;height:300px;" />
